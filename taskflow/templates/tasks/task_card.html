{% load static %}
<div class="task-card bg-white border rounded-3 shadow-sm p-3 card-color" style="min-width: 0; width: 100%;">
    <!-- Верхняя часть: приоритет + заголовок -->

    <div class="task-card bg-white border rounded-3 shadow-sm p-3
            {% if task.priority == 'high' %}
                priority-high
            {% elif task.priority == 'medium' %}
                priority-medium
            {% else %}
                priority-low
            {% endif %}"
        style="min-width: 0; width: 100%;">

        <!-- Заголовок и описание -->
        <div class="w-100">
            <h6 class="
                mb-1 fs-6 font-weight-normal line-height-sm
                task-title
                {% if task.priority == 'high' %}
                    priority-high
                {% elif task.priority == 'medium' %}
                    priority-medium
                {% else %}
                    priority-low
                {% endif %}
            " style="word-wrap: break-word; white-space: normal;">
                {{ task.title }}
            </h6>
            {% if task.description %}
                <p class="text-muted small mb-0 mt-1">
                    {{ task.description|truncatewords:15|linebreaksbr }}
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Нижняя часть: метаданные -->
    <div class="small text-muted">
        <!-- Статус -->
        <div class="mb-2">
            <label class="form-label fst-italic">Статус:</label>
            {% if task.is_overdue %}
                <!-- Если задача просрочена → только текст и hidden-поле -->
                <div class="text-danger d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    <span>Просрочено</span>
                </div>
                <input type="hidden" name="status" value="overdue">
                <small class="text-muted">
                    Срок истёк {{ task.due_date|date:"d M Y, H:i" }}.<br>
                    Для смены статуса обновите дату выполнения.
                </small>
            {% else %}
                <!-- Иначе показываем селектор -->
                <select class="form-select form-select-sm" id="status-select-{{ task.pk }}">
                    <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>К выполнению</option>
                    <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>В работе</option>
                    <option value="done" {% if task.status == 'done' %}selected{% endif %}>Выполнено</option>
                    <option value="overdue" {% if task.status == 'overdue' %}selected{% endif %}>Просрочено</option>
                </select>
            {% endif %}
        </div>
        <!-- Дата выполнения -->
        <div class="mb-1">
            <label class="form-label fst-italic">Срок:</label>
            <div class="d-flex align-items-center">
                <i class="bi bi-calendar-event me-1"></i>
                <span>{{ task.due_date|date:"d M Y, H:i" }}</span>
            </div>
        </div>
    </div>

    <!-- Кнопки управления -->
    <div class="d-flex justify-content-end mt-3">
        <a href="{% url 'task_update' task.pk %}"
        class="btn-task-edit btn rounded-circle me-2"
        title="Редактировать задачу">
            <i class="bi bi-pencil"></i>
        </a>
        <form method="post" action="{% url 'task_delete' task.pk %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit"
                    class="btn-task-delete btn rounded-circle"
                    onclick="return confirm('Удалить задачу?')"
                    title="Удалить задачу">
                <i class="bi bi-trash"></i>
            </button>
        </form>
    </div>
</div>

<!-- JavaScript для обработки смены статуса -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectElements = document.querySelectorAll('.form-select-sm');
    
    selectElements.forEach(select => {
        select.addEventListener('change', function() {
            const taskId = this.id.split('-').pop();
            const newStatus = this.value;
            
            fetch(`/task/${taskId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect_url;
                } else {
                    showErrorMessage('Ошибка при обновлении статуса');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showErrorMessage('Произошла ошибка при обновлении статуса');
            });
        });
    });
});

function showErrorMessage(message) {
    const alert = document.createElement('div');
    alert.classList.add('alert', 'alert-danger', 'position-fixed', 'top-0', 'end-0', 'p-3', 'rounded-0');
    alert.style.zIndex = '1030';
    alert.innerHTML = `<strong>${message}</strong>`;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 3000);
}
</script>
